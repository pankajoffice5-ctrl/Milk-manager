<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Ledger | PDF Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-24">

    <header class="bg-blue-600 p-6 text-white shadow-md sticky top-0 z-30">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black">MilkLog Fix</h1>
            <div class="flex gap-2">
                <button onclick="switchTab('logs')" class="text-xs font-bold bg-white/20 px-4 py-2 rounded-xl">Logs</button>
                <button onclick="switchTab('members')" class="text-xs font-bold bg-white/20 px-4 py-2 rounded-xl">Members</button>
            </div>
        </div>
    </header>

    <main id="tab-members" class="hidden max-w-md mx-auto p-4 space-y-4">
        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200">
            <h2 class="text-xs font-bold text-slate-400 uppercase mb-3">Add Member</h2>
            <form onsubmit="addMember(event)" class="flex gap-2">
                <input type="text" id="member-name" placeholder="Name" class="flex-1 bg-slate-100 p-3 rounded-xl outline-none text-sm" required>
                <button type="submit" class="bg-blue-600 text-white px-6 rounded-xl font-bold">+</button>
            </form>
        </div>
        <div id="members-list" class="space-y-2"></div>
    </main>

    <main id="tab-logs" class="max-w-md mx-auto p-4 space-y-4">
        <div class="bg-white rounded-3xl p-5 shadow-lg border border-slate-200">
            <form onsubmit="saveEntry(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <select id="log-member" class="bg-slate-100 p-3 rounded-xl text-sm outline-none font-bold" required>
                        <option value="">Member</option>
                    </select>
                    <input type="date" id="log-date" class="bg-slate-100 p-3 rounded-xl text-sm outline-none">
                </div>
                <input type="number" id="log-qty" step="0.1" placeholder="Quantity (Liters)" class="w-full bg-slate-100 p-4 rounded-xl text-xl font-black outline-none text-center" required>
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl">Save Entry</button>
            </form>
        </div>

        <div class="bg-blue-50 rounded-3xl p-5 border border-blue-200 space-y-3">
            <p class="text-[10px] font-bold text-blue-600 uppercase text-center">Export Specific Member PDF</p>
            <div class="flex gap-2">
                <select id="filter-member" class="flex-1 bg-white p-3 rounded-xl text-sm outline-none border border-blue-200">
                    <option value="">All Members</option>
                </select>
                <button onclick="exportToPDF()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold">Download PDF</button>
            </div>
        </div>

        <div id="logs-display" class="space-y-2"></div>
    </main>

    <div id="pdf-container" style="padding: 40px; background: white; font-family: Arial, sans-serif; display: none;">
        <div style="border-bottom: 3px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="color: #2563eb; font-size: 28px; margin: 0;">Milk Supply Report</h1>
            <p id="pdf-report-for" style="font-weight: bold; color: #666; text-transform: uppercase; margin-top: 5px;"></p>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f1f5f9; text-align: left;">
                    <th style="padding: 12px; border: 1px solid #cbd5e1;">Date</th>
                    <th style="padding: 12px; border: 1px solid #cbd5e1;">Member Name</th>
                    <th style="padding: 12px; border: 1px solid #cbd5e1;">Quantity (Ltrs)</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                </tbody>
        </table>
        <div style="margin-top: 20px; text-align: right;">
            <h2 id="pdf-grand-total" style="font-size: 20px; color: #000;"></h2>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.getElementById('tab-members').classList.toggle('hidden', tab !== 'members');
            document.getElementById('tab-logs').classList.toggle('hidden', tab !== 'logs');
        }

        function addMember(e) {
            e.preventDefault();
            const name = document.getElementById('member-name').value;
            const members = JSON.parse(localStorage.getItem('milk_members') || '[]');
            members.push({ id: Date.now(), name });
            localStorage.setItem('milk_members', JSON.stringify(members));
            e.target.reset();
            renderMembers();
        }

        function renderMembers() {
            const members = JSON.parse(localStorage.getItem('milk_members') || '[]');
            document.getElementById('members-list').innerHTML = members.map(m => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm">
                    <span class="font-bold text-slate-700">${m.name}</span>
                    <button onclick="deleteMember(${m.id})" class="text-red-500 text-xs font-bold">REMOVE</button>
                </div>
            `).join('');

            const options = members.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
            document.getElementById('log-member').innerHTML = '<option value="">Member</option>' + options;
            document.getElementById('filter-member').innerHTML = '<option value="">All Members</option>' + options;
        }

        function deleteMember(id) {
            const members = JSON.parse(localStorage.getItem('milk_members') || '[]');
            localStorage.setItem('milk_members', JSON.stringify(members.filter(m => m.id !== id)));
            renderMembers();
        }

        function saveEntry(e) {
            e.preventDefault();
            const entry = {
                id: Date.now(),
                member: document.getElementById('log-member').value,
                date: document.getElementById('log-date').value,
                qty: parseFloat(document.getElementById('log-qty').value)
            };
            const logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            logs.unshift(entry);
            localStorage.setItem('milk_logs', JSON.stringify(logs));
            e.target.reset();
            initApp();
        }

        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            document.getElementById('logs-display').innerHTML = logs.map(l => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">${l.date} • ${l.member}</p>
                        <p class="text-lg font-black text-slate-800">${l.qty} Liters</p>
                    </div>
                    <button onclick="deleteLog(${l.id})" class="text-slate-300">✕</button>
                </div>
            `).join('');
        }

        function deleteLog(id) {
            const logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            localStorage.setItem('milk_logs', JSON.stringify(logs.filter(l => l.id !== id)));
            renderLogs();
        }

        // --- FIXED PDF LOGIC ---
        function exportToPDF() {
            const selectedMember = document.getElementById('filter-member').value;
            let logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            
            // 1. Filter logs for selected member
            if (selectedMember) {
                logs = logs.filter(l => l.member === selectedMember);
            }

            // 2. Sort by date
            logs.sort((a,b) => new Date(a.date) - new Date(b.date));

            // 3. Populate PDF table
            const tableBody = document.getElementById('pdf-table-body');
            let totalLiters = 0;
            let rowsHtml = '';

            logs.forEach(l => {
                totalLiters += l.qty;
                rowsHtml += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #cbd5e1;">${l.date}</td>
                        <td style="padding: 10px; border: 1px solid #cbd5e1;">${l.member}</td>
                        <td style="padding: 10px; border: 1px solid #cbd5e1; font-weight: bold;">${l.qty} L</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = rowsHtml;
            document.getElementById('pdf-report-for').innerText = selectedMember ? `MEMBER: ${selectedMember}` : "FULL CUSTOMER REPORT";
            document.getElementById('pdf-grand-total').innerText = `GRAND TOTAL: ${totalLiters.toFixed(1)} Liters`;

            // 4. Generate PDF
            const element = document.getElementById('pdf-container');
            element.style.display = 'block'; // Temporarily show for capture

            const opt = {
                margin: 0.5,
                filename: selectedMember ? `Milk_${selectedMember}.pdf` : 'Milk_Report_Full.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none'; // Hide again
            });
        }

        function initApp() {
            renderMembers();
            renderLogs();
            document.getElementById('log-date').valueAsDate = new Date();
        }

        window.onload = initApp;
    </script>
</body>
</html>
