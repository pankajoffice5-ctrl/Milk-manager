<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Ledger | Smart Grouping</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-24">

    <header class="bg-blue-600 p-6 text-white shadow-md sticky top-0 z-30">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black uppercase tracking-tighter">MilkLog Pro</h1>
            <div class="flex gap-2">
                <button onclick="switchTab('logs')" class="text-xs font-bold bg-white/20 px-4 py-2 rounded-xl">Logs</button>
                <button onclick="switchTab('members')" class="text-xs font-bold bg-white/20 px-4 py-2 rounded-xl">Members</button>
            </div>
        </div>
    </header>

    <main id="tab-members" class="hidden max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200 mb-4">
            <form onsubmit="addMember(event)" class="flex gap-2">
                <input type="text" id="member-name" placeholder="Member Name" class="flex-1 bg-slate-100 p-3 rounded-xl outline-none text-sm" required>
                <button type="submit" class="bg-blue-600 text-white px-6 rounded-xl font-bold">+</button>
            </form>
        </div>
        <div id="members-list" class="space-y-2"></div>
    </main>

    <main id="tab-logs" class="max-w-md mx-auto p-4 space-y-4">
        <div class="bg-white rounded-3xl p-5 shadow-lg border border-slate-200">
            <form onsubmit="saveEntry(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <select id="log-member" class="bg-slate-100 p-3 rounded-xl text-sm outline-none font-bold" required>
                        <option value="">Member</option>
                    </select>
                    <input type="date" id="log-date" class="bg-slate-100 p-3 rounded-xl text-sm outline-none" required>
                </div>
                <input type="number" id="log-qty" step="0.1" placeholder="Quantity (Pav)" class="w-full bg-slate-100 p-4 rounded-xl text-xl font-black outline-none text-center" required>
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl">Save Entry</button>
            </form>
        </div>

        <div class="bg-emerald-50 rounded-3xl p-5 border border-emerald-200 space-y-3">
            <p class="text-[10px] font-bold text-emerald-700 uppercase text-center">Export Grouped Invoice</p>
            <div class="flex gap-2">
                <select id="filter-member" class="flex-1 bg-white p-3 rounded-xl text-sm outline-none border border-emerald-200">
                    <option value="">Select Member</option>
                </select>
                <button onclick="exportToPDF()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold">PDF</button>
            </div>
        </div>
        <div id="logs-display" class="space-y-2"></div>
    </main>

    <div id="pdf-container" style="display: none; padding: 30px; background: white; color: black; width: 100%; font-family: sans-serif;">
        <div style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between;">
            <h1 style="margin: 0; font-size: 20px;">MILK BILL</h1>
            <p id="pdf-gen-date" style="margin: 0; font-size: 10px;"></p>
        </div>
        
        <p style="margin: 0; font-weight: bold; font-size: 14px;">Customer: <span id="pdf-member-name"></span></p>

        <h3 style="font-size: 12px; margin-top: 20px; text-decoration: underline;">Summary (Qty Grouping)</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;">
            <thead>
                <tr style="background: #f1f5f9; border: 1px solid #000;">
                    <th style="padding: 6px; border: 1px solid #000; text-align: left;">Milk Quantity</th>
                    <th style="padding: 6px; border: 1px solid #000; text-align: center;">Total Days</th>
                    <th style="padding: 6px; border: 1px solid #000; text-align: right;">Total Pav</th>
                </tr>
            </thead>
            <tbody id="pdf-group-body"></tbody>
        </table>

        <h3 style="font-size: 12px; margin-top: 10px; text-decoration: underline;">Daily Details</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed;">
            <thead>
                <tr style="background: #f1f5f9; border: 1px solid #000;">
                    <th style="padding: 4px; border: 1px solid #000; text-align: left; width: 40%;">Date</th>
                    <th style="padding: 4px; border: 1px solid #000; text-align: right; width: 60%;">Quantity (Pav)</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body"></tbody>
            <tfoot>
                <tr style="font-weight: bold;">
                    <td style="padding: 8px; border: 1px solid #000;">GRAND TOTAL</td>
                    <td id="pdf-total-qty" style="padding: 8px; border: 1px solid #000; text-align: right;"></td>
                </tr>
                <tr style="font-weight: bold; background: #fafafa;">
                    <td style="padding: 8px; border: 1px solid #000;">TOTAL AMOUNT</td>
                    <td id="pdf-total-amount" style="padding: 8px; border: 1px solid #000; text-align: right; font-size: 14px;"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script>
        const formatDate = (d) => d.split('-').reverse().join('-');

        function switchTab(tab) {
            document.getElementById('tab-members').classList.toggle('hidden', tab !== 'members');
            document.getElementById('tab-logs').classList.toggle('hidden', tab !== 'logs');
        }

        function addMember(e) {
            e.preventDefault();
            const members = JSON.parse(localStorage.getItem('milk_members') || '[]');
            members.push({ id: Date.now(), name: document.getElementById('member-name').value });
            localStorage.setItem('milk_members', JSON.stringify(members));
            e.target.reset(); renderMembers();
        }

        function renderMembers() {
            const members = JSON.parse(localStorage.getItem('milk_members') || '[]');
            document.getElementById('members-list').innerHTML = members.map(m => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm">
                    <span class="font-bold text-slate-700">${m.name}</span>
                    <button onclick="deleteMember(${m.id})" class="text-red-500 font-bold text-xs uppercase">Delete</button>
                </div>`).join('');
            const opts = members.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
            document.getElementById('log-member').innerHTML = '<option value="">Member</option>' + opts;
            document.getElementById('filter-member').innerHTML = '<option value="">Select Member</option>' + opts;
        }

        function deleteMember(id) {
            const m = JSON.parse(localStorage.getItem('milk_members') || '[]');
            localStorage.setItem('milk_members', JSON.stringify(m.filter(x => x.id !== id)));
            renderMembers();
        }

        function saveEntry(e) {
            e.preventDefault();
            const member = document.getElementById('log-member').value;
            const date = document.getElementById('log-date').value;
            const qty = parseFloat(document.getElementById('log-qty').value);
            const logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            if (logs.some(l => l.member === member && l.date === date)) return alert("Date exists!");
            logs.unshift({ id: Date.now(), member, date, qty });
            localStorage.setItem('milk_logs', JSON.stringify(logs));
            e.target.reset(); initApp();
        }

        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            document.getElementById('logs-display').innerHTML = logs.map(l => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div><p class="text-[9px] font-bold text-slate-400 uppercase">${formatDate(l.date)} • ${l.member}</p>
                    <p class="text-lg font-black text-slate-800">${l.qty} Pav</p></div>
                    <button onclick="deleteLog(${l.id})" class="text-slate-200">✕</button>
                </div>`).join('');
        }

        function deleteLog(id) {
            const l = JSON.parse(localStorage.getItem('milk_logs') || '[]');
            localStorage.setItem('milk_logs', JSON.stringify(l.filter(x => x.id !== id)));
            renderLogs();
        }

        function exportToPDF() {
            const name = document.getElementById('filter-member').value;
            if (!name) return alert("Select Member");
            const rate = prompt("Enter Rate per Pav", "15");
            if (!rate) return;

            let logs = JSON.parse(localStorage.getItem('milk_logs') || '[]').filter(l => l.member === name);
            logs.sort((a,b) => new Date(a.date) - new Date(b.date));

            // --- UNIQUE PAV LOGIC ---
            const groups = {}; // { "2": count, "3": count }
            logs.forEach(l => {
                groups[l.qty] = (groups[l.qty] || 0) + 1;
            });

            let groupHtml = '';
            for (let qty in groups) {
                groupHtml += `<tr>
                    <td style="padding:6px; border:1px solid #000;">${qty} Pav</td>
                    <td style="padding:6px; border:1px solid #000; text-align:center;">${groups[qty]} Days</td>
                    <td style="padding:6px; border:1px solid #000; text-align:right;">${qty * groups[qty]} Pav</td>
                </tr>`;
            }
            document.getElementById('pdf-group-body').innerHTML = groupHtml;

            // --- DAILY DETAIL LOGIC ---
            let totalQty = 0;
            let detailHtml = logs.map(l => {
                totalQty += l.qty;
                return `<tr><td style="padding:4px; border:1px solid #000;">${formatDate(l.date)}</td>
                        <td style="padding:4px; border:1px solid #000; text-align:right;">${l.qty} Pav</td></tr>`;
            }).join('');

            document.getElementById('pdf-table-body').innerHTML = detailHtml;
            document.getElementById('pdf-member-name').innerText = name;
            document.getElementById('pdf-total-qty').innerText = totalQty.toFixed(1) + " Pav";
            document.getElementById('pdf-total-amount').innerText = "₹" + (totalQty * rate).toFixed(2);
            document.getElementById('pdf-gen-date').innerText = "Bill Date: " + formatDate(new Date().toISOString().split('T')[0]);

            const el = document.getElementById('pdf-container');
            el.style.display = 'block';
            html2pdf().from(el).set({ margin:0.5, filename:`${name}_Bill.pdf`, html2canvas:{scale:3}, jsPDF:{unit:'in', format:'a4'} }).save().then(()=>el.style.display='none');
        }

        function initApp() { renderMembers(); renderLogs(); document.getElementById('log-date').valueAsDate = new Date(); }
        window.onload = initApp;
    </script>
</body>
</html>
